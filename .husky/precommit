#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Pre-commit validation started..."

# Dockerç’°å¢ƒç¢ºèª
echo "ğŸ³ Checking Docker services..."
if ! docker compose ps | grep -q "Up"; then
  echo "ğŸš€ Starting Docker services..."
  docker compose up -d
  
  # ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•å¾…æ©Ÿ
  echo "â³ Waiting for services to be ready..."
  npx wait-on http://localhost:5173 --timeout 60000
  
  if [ $? -ne 0 ]; then
    echo "âŒ Services failed to start. Please check Docker configuration."
    exit 1
  fi
else
  echo "âœ… Docker services are already running"
fi

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç¢ºèª
echo "ğŸ—„ï¸  Checking database connection..."
if ! docker compose exec postgres pg_isready -U survey_user > /dev/null 2>&1; then
  echo "âŒ Database is not ready. Please check PostgreSQL container."
  exit 1
fi

# E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆSmoke testã®ã¿ï¼‰
echo "ğŸ­ Running Playwright smoke tests..."
npx playwright test --grep="@smoke"

# ãƒ†ã‚¹ãƒˆçµæœç¢ºèª
TEST_RESULT=$?
if [ $TEST_RESULT -ne 0 ]; then
  echo ""
  echo "âŒ E2E tests failed. Commit aborted."
  echo "ğŸ’¡ To debug:"
  echo "   npm run test:e2e:ui      # Interactive debugging"
  echo "   npm run test:e2e:headed  # Run with browser UI"
  echo "   git commit --no-verify   # Skip hooks (use with caution)"
  echo ""
  exit 1
fi

echo "âœ… All smoke tests passed!"

# TypeScriptå‹ãƒã‚§ãƒƒã‚¯ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼‰
if [ -d "backend" ]; then
  echo "ğŸ”§ Running TypeScript check for backend..."
  cd backend && npm run type-check 2>/dev/null
  if [ $? -ne 0 ]; then
    echo "âš ï¸  TypeScript check failed for backend, but continuing..."
  else
    echo "âœ… Backend TypeScript check passed"
  fi
  cd ..
fi

# TypeScriptå‹ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼‰
if [ -d "frontend" ]; then
  echo "ğŸ”§ Running TypeScript check for frontend..."
  cd frontend && npm run type-check 2>/dev/null
  if [ $? -ne 0 ]; then
    echo "âš ï¸  TypeScript check failed for frontend, but continuing..."
  else
    echo "âœ… Frontend TypeScript check passed"
  fi
  cd ..
fi

echo ""
echo "ğŸ‰ Pre-commit validation completed successfully!"
echo "ğŸ“ Proceeding with commit..."