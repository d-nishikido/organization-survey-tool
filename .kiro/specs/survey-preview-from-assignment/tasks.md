# 実装計画

## 概要
質問割り当て画面に調査プレビュー機能を追加します。HR担当者が質問の割り当て作業中に、実際の調査画面をモーダルウィンドウでプレビューできるようにします。

---

- [x] 1. 質問割り当て画面にプレビューボタンを追加
- [x] 1.1 プレビューボタンのUI実装
  - 質問割り当て画面のヘッダー領域にプレビューボタンを配置
  - ボタンのラベルとアイコンを適切に設定
  - Tailwind CSSを使用して既存のUIスタイルと統一されたデザインを適用
  - _要件: 1.1, 1.4_

- [x] 1.2 プレビューボタンの有効/無効状態制御
  - 割り当て済み質問の数に基づいてボタンの有効/無効を切り替える機能を実装
  - 質問が1つも割り当てられていない場合はボタンを無効化
  - 無効状態のボタンにホバーした際にツールチップで「質問を割り当ててください」と表示
  - _要件: 1.2, 1.3_

- [x] 1.3 プレビューモーダルの開閉状態管理
  - プレビューモーダルの開閉状態を管理するためのuseStateフックを追加
  - プレビューボタンクリック時にモーダルを開くハンドラーを実装
  - モーダルを閉じるためのハンドラーを実装
  - _要件: 2.1, 4.2_

---

- [x] 2. 調査プレビューモーダルコンポーネントの作成
- [x] 2.1 SurveyPreviewModalコンポーネントの基本構造実装
  - 新規コンポーネントファイルをfrontend/src/components/admin/に作成
  - propsインターフェースを定義（isOpen, onClose, survey, assignedQuestions）
  - 既存のModalコンポーネントをラップして使用
  - Modalのサイズを'xl'に設定し、大きめの表示領域を確保
  - _要件: 2.1, 2.3, 2.4_

- [x] 2.2 モーダル内の調査メタデータ表示
  - 調査タイトルを中央揃えで大きく表示
  - 調査の説明文を表示（存在する場合）
  - 実施期間（開始日〜終了日）を日本語フォーマットで表示
  - 匿名回答の保証メッセージを表示（is_anonymousがtrueの場合）
  - _要件: 2.5_

- [x] 2.3 モーダルの閉じる機能の統合
  - 既存のModalコンポーネントの閉じるボタン（×）を有効化
  - closeOnEscapeとcloseOnOverlayClickをtrueに設定
  - ESCキー押下でモーダルが閉じることを確認
  - オーバーレイクリックでモーダルが閉じることを確認
  - _要件: 4.1, 4.2, 4.3, 4.4, 4.5_

---

- [ ] 3. 質問リスト表示とカテゴリグループ化の実装
- [ ] 3.1 質問リストの基本レンダリング
  - 割り当て済み質問をorder_num順にソートして表示
  - 各質問のテキスト、タイプ、必須マークを表示
  - 質問番号を自動採番して表示（1, 2, 3...）
  - _要件: 3.1, 3.2, 3.3, 5.3_

- [ ] 3.2 質問タイプ別の表示コンポーネント実装
  - テキスト質問（text/textarea）の表示フォーマットを実装
  - Yes/No質問の選択肢表示を実装
  - 多肢選択（multiple_choice/checkbox）の選択肢リスト表示を実装
  - 評価スケール（rating/rating_5/rating_10）の星またはスケール表示を実装
  - スケール質問（scale）の数値範囲表示を実装
  - すべての入力要素を無効化し、視覚的プレビューのみ提供
  - _要件: 5.1, 5.2, 5.4_

- [ ] 3.3 カテゴリグループ化の実装
  - 質問をcategory_idでグループ化
  - 各カテゴリセクションにカテゴリ名のヘッダーを表示
  - カテゴリ内で質問を順序通りに表示
  - カテゴリ間に視覚的な区切りを追加
  - _要件: 3.4_

---

- [ ] 4. エラーハンドリングとローディング状態の実装
- [ ] 4.1 ローディング状態の実装
  - プレビューモーダルの読み込み中にLoadingコンポーネントを表示
  - ローディング状態を管理するuseStateフックを追加
  - データ取得中は質問リストの代わりにローディングインジケーターを表示
  - _要件: 6.1_

- [ ] 4.2 エラー状態の実装とユーザーフィードバック
  - エラー状態を管理するuseStateフックを追加
  - 調査データ取得失敗時にAlertコンポーネントでエラーメッセージを表示
  - エラーメッセージに「再試行」ボタンを配置
  - 質問データ取得失敗時に適切なエラーメッセージを表示
  - _要件: 6.2, 6.3, 6.4_

---

- [ ] 5. SurveyQuestionAssignmentへのプレビュー機能統合
- [ ] 5.1 プレビューボタンとモーダルの統合
  - SurveyQuestionAssignmentコンポーネントにプレビューボタンを追加
  - SurveyPreviewModalコンポーネントをインポートして配置
  - 必要なprops（surveyData, assignedQuestions）をモーダルに渡す
  - プレビューモーダルの開閉状態を適切に管理
  - _要件: 1.1, 2.1, 3.1, 3.2_

- [ ] 5.2 動的更新の確認と調整
  - プレビューを閉じて質問を追加・削除した後の動作を確認
  - 質問の順序変更後にプレビューに反映されることを確認
  - プレビューモーダル内で最新のassignedQuestionsが使用されることを確認
  - _要件: 3.2, 3.3_

---

- [ ] 6. ユニットテストの作成
- [ ] 6.1 SurveyPreviewModalコンポーネントのテスト
  - モーダルが正しく開閉することを確認するテスト
  - 調査メタデータが正しく表示されることを確認するテスト
  - 質問リストが正しくレンダリングされることを確認するテスト
  - カテゴリグループ化が正しく動作することを確認するテスト

- [ ] 6.2 プレビューボタンのテスト
  - ボタンが正しくレンダリングされることを確認するテスト
  - 質問が割り当てられていない場合にボタンが無効化されることを確認するテスト
  - 質問が割り当てられている場合にボタンが有効化されることを確認するテスト
  - ボタンクリック時にモーダルが開くことを確認するテスト

- [ ] 6.3 エラーハンドリングのテスト
  - エラー状態が正しく表示されることを確認するテスト
  - ローディング状態が正しく表示されることを確認するテスト
  - 再試行ボタンが機能することを確認するテスト

---

- [ ] 7. E2Eテストの作成と実行
- [ ] 7.1 基本フローのE2Eテスト
  - 質問割り当て画面にアクセスし、質問を割り当てるシナリオを作成
  - プレビューボタンをクリックしてモーダルが開くことを確認
  - モーダル内に質問が表示されることを確認
  - 閉じるボタン、ESCキー、オーバーレイクリックでモーダルが閉じることを確認

- [ ] 7.2 動的更新のE2Eテスト
  - プレビューを開いて閉じた後、質問を追加するシナリオを作成
  - 再度プレビューを開いて、追加された質問が表示されることを確認
  - 質問の順序を変更した後、プレビューに反映されることを確認

- [ ] 7.3 エラーケースのE2Eテスト
  - 質問が割り当てられていない状態でプレビューボタンが無効化されることを確認
  - ツールチップが正しく表示されることを確認
