# 要件定義書 (Requirements Document)

## はじめに

分析ダッシュボードは、組織改善ツールにおける調査結果の分析・可視化を担う中核機能です。HR担当者が収集した匿名調査データをリアルタイムで集計・分析し、カテゴリ別の傾向、統計情報、トレンド分析を通じて、データ駆動の意思決定を支援します。

本機能により、HR担当者は調査の進捗状況を把握し、カテゴリ別のスコア分析、時系列トレンド、レスポンス分布などを直感的なグラフとして確認できます。また、Excel/CSV形式でのエクスポート機能により、詳細な二次分析も可能とします。

## 要件

### 要件1: 調査サマリー表示

**目的:** HR担当者として、調査の全体状況を一目で把握できるサマリー情報を確認したい。そうすることで、回答状況や全体的な傾向を迅速に理解できる。

#### 受入基準

1. WHEN HR担当者が分析ダッシュボードにアクセスする THEN システムは選択された調査のサマリー情報を表示する
2. IF 調査にレスポンスデータが存在する THEN システムは以下のサマリー指標を計算して表示する:
   - 総回答数
   - 完了率（目標回答数に対する実績の割合）
   - カテゴリ別平均スコア
   - 回答分布（スコア1-5の度数分布）
3. WHEN サマリーデータがキャッシュされている AND キャッシュが有効期限内である THEN システムはキャッシュデータを表示する
4. WHEN 新しいレスポンスが追加される THEN システムは該当調査のキャッシュを無効化する
5. WHERE サマリーカード表示領域 THE システムは各指標を視覚的に理解しやすいカード形式で表示する

### 要件2: カテゴリ別分析

**目的:** HR担当者として、7つのカテゴリ（A-G）ごとの詳細な分析結果を確認したい。そうすることで、問題領域や強み領域を特定できる。

#### 受入基準

1. WHEN HR担当者がカテゴリ別分析タブを選択する THEN システムは全カテゴリ（A-G）の分析結果を表示する
2. IF 特定のカテゴリが選択されている THEN システムはそのカテゴリのみの詳細分析を表示する
3. WHERE 各カテゴリ分析 THE システムは以下の統計情報を提供する:
   - 回答数
   - 平均スコア
   - 標準偏差
   - 最小値・最大値
   - 中央値
   - 分布グラフ（ヒストグラム）
4. WHEN カテゴリ別データが表示される THEN システムはカテゴリコード（A-G）とカテゴリ名を明示する
5. IF カテゴリに回答データが存在しない THEN システムは「データなし」メッセージを表示する

### 要件3: グラフ可視化

**目的:** HR担当者として、調査結果を視覚的に理解しやすいグラフで確認したい。そうすることで、パターンや傾向を直感的に把握できる。

#### 受入基準

1. WHEN カテゴリ別分析が表示される THEN システムはレーダーチャートで全カテゴリのスコアを可視化する
2. WHEN 回答分布が表示される THEN システムは棒グラフで各スコア（1-5）の度数を可視化する
3. WHEN トレンド分析が表示される THEN システムは折れ線グラフで時系列変化を可視化する
4. WHERE グラフ表示領域 THE システムはRechartsライブラリを使用してインタラクティブなグラフを提供する
5. IF グラフ上でデータポイントにカーソルを合わせる THEN システムは詳細な数値をツールチップで表示する
6. WHEN グラフが生成される AND データが存在しない THEN システムは「データ不足」メッセージを表示する

### 要件4: トレンド分析

**目的:** HR担当者として、調査結果の時系列変化を確認したい。そうすることで、組織の改善状況や悪化傾向を早期に検知できる。

#### 受入基準

1. WHEN HR担当者がトレンド分析を選択する THEN システムは指定期間のトレンドデータを表示する
2. WHERE 期間選択 THE システムは以下の期間オプションを提供する:
   - 日次 (daily)
   - 週次 (weekly)
   - 月次 (monthly)
   - 四半期 (quarterly)
3. WHEN トレンド分析が実行される THEN システムは以下を算出する:
   - 各期間の平均スコア
   - 回答数
   - トレンド方向（増加・減少・安定）
   - 変化率（％）
4. IF 特定カテゴリが選択されている THEN システムはそのカテゴリのみのトレンドを表示する
5. WHEN トレンド期間が過去1年を超える THEN システムは直近1年間のデータのみを表示する
6. IF データポイントが2点未満 THEN システムはトレンド方向を「安定」として扱う

### 要件5: フィルタリング機能

**目的:** HR担当者として、特定の条件で分析結果を絞り込みたい。そうすることで、関心のあるデータセグメントに焦点を当てた分析ができる。

#### 受入基準

1. WHEN HR担当者がフィルタパネルを開く THEN システムは利用可能なフィルタオプションを表示する
2. WHERE フィルタパネル THE システムは以下のフィルタを提供する:
   - 調査選択（ドロップダウン）
   - カテゴリ選択（A-Gのチェックボックス）
   - 期間選択（トレンド分析用）
3. WHEN フィルタが適用される THEN システムは全てのグラフと統計情報をフィルタ条件に基づいて更新する
4. WHEN フィルタがクリアされる THEN システムは全データを表示する初期状態に戻る
5. IF 複数のフィルタが同時に適用される THEN システムはAND条件で絞り込みを行う

### 要件6: データエクスポート

**目的:** HR担当者として、分析結果をExcelまたはCSV形式でエクスポートしたい。そうすることで、詳細な二次分析や経営層への報告資料作成ができる。

#### 受入基準

1. WHEN HR担当者がエクスポートボタンをクリックする THEN システムはエクスポート形式選択ダイアログを表示する
2. WHERE エクスポート形式選択 THE システムは以下の形式オプションを提供する:
   - Excel (.xlsx)
   - CSV (.csv)
3. WHEN Excel形式が選択される THEN システムは以下のシートを含むワークブックを生成する:
   - サマリーシート（調査概要と主要指標）
   - カテゴリ別分析シート
   - 回答詳細シート（個別レスポンス、匿名性を保った形式）
4. WHEN CSV形式が選択される THEN システムは全レスポンスデータをUTF-8エンコードのCSVファイルとして生成する
5. WHEN エクスポートが実行される THEN システムは現在適用されているフィルタ条件を反映したデータをエクスポートする
6. IF エクスポート対象データが大量である（>10000行） THEN システムは進捗インジケータを表示する

### 要件7: リアルタイム更新

**目的:** HR担当者として、新しい回答が追加された際に自動的にダッシュボードが更新されることを期待する。そうすることで、常に最新の分析結果を確認できる。

#### 受入基準

1. WHEN 新しいレスポンスがデータベースに追加される THEN システムは該当調査の分析キャッシュを無効化する
2. WHEN HR担当者がダッシュボードを表示している AND キャッシュが無効化されている THEN システムは最新データで再集計を実行する
3. WHERE ダッシュボード表示中 THE システムは定期的（5分ごと）にデータの更新を確認する
4. IF データ更新が検出される THEN システムはユーザーに更新通知を表示する
5. WHEN ユーザーが更新通知を承認する THEN システムはダッシュボードを最新データで再描画する

### 要件8: パフォーマンス要件

**目的:** HR担当者として、大量のレスポンスデータがある場合でも、ダッシュボードが迅速に表示されることを期待する。そうすることで、ストレスなく分析作業を行える。

#### 受入基準

1. WHEN ダッシュボードが初回ロードされる AND レスポンスデータが1000件未満 THEN システムは3秒以内にサマリーを表示する
2. WHEN キャッシュデータが存在する THEN システムは1秒以内にダッシュボードを表示する
3. WHERE グラフ描画 THE システムは描画処理をノンブロッキングで実行する
4. WHEN 大量データの集計が必要 THEN システムはローディングインジケータを表示する
5. IF 集計処理が10秒を超える THEN システムはタイムアウトエラーを表示し、キャッシュの更新を推奨する

### 要件9: エラーハンドリング

**目的:** HR担当者として、エラーが発生した場合に適切なメッセージと対処方法が提示されることを期待する。そうすることで、問題を自己解決または適切にエスカレーションできる。

#### 受入基準

1. WHEN データベース接続エラーが発生する THEN システムは「データベース接続エラー。しばらく待ってから再試行してください」メッセージを表示する
2. WHEN 不正な調査IDが指定される THEN システムは「指定された調査が見つかりません」メッセージを表示する
3. WHEN データ集計処理でエラーが発生する THEN システムはエラー詳細をログに記録し、ユーザーには汎用エラーメッセージを表示する
4. WHERE エラー表示 THE システムは「再試行」ボタンを提供する
5. IF 再試行が3回失敗する THEN システムは「システム管理者に連絡してください」メッセージを追加表示する

### 要件10: アクセス制御

**目的:** システム管理者として、分析ダッシュボードへのアクセスを適切に制御したい。そうすることで、権限のないユーザーが機密データを閲覧することを防げる。

#### 受入基準

1. WHEN 一般従業員が分析ダッシュボードにアクセスしようとする THEN システムは403 Forbiddenエラーを返し、アクセスを拒否する
2. WHEN HR担当者が分析ダッシュボードにアクセスする THEN システムはダッシュボードを表示する
3. WHERE ルート定義 THE システムは`/admin/analytics`パスにHRRouteガードを適用する
4. WHEN 認証されていないユーザーがアクセスする THEN システムはログインページにリダイレクトする
5. IF 将来的にMicrosoft365 SSOが実装される THEN システムはAzure ADのロールクレームを使用してHR権限を判定する

## 非機能要件

### パフォーマンス
- ダッシュボード初回ロード時間: 3秒以内（1000件のレスポンスデータ）
- キャッシュヒット時のロード時間: 1秒以内
- グラフ描画時間: 500ms以内

### スケーラビリティ
- 最大10,000レスポンス/調査をサポート
- 同時接続ユーザー数: 50人（HR担当者）

### 可用性
- キャッシュ有効期限: 24時間（デフォルト）
- データ更新確認間隔: 5分

### セキュリティ
- 匿名性保証: 個別レスポンスから個人を特定できない集計のみ表示
- 最小集計単位: 3レスポンス以上（個人特定防止）

### 互換性
- サポートブラウザ: Chrome 最新版、Edge 最新版、Firefox 最新版
- モバイル対応: レスポンシブデザイン（タブレット以上）
