# 実装計画 (Implementation Plan)

## タスク概要

本実装計画は、分析ダッシュボード機能の段階的な開発タスクを定義しています。既存のAnalyticsServiceとAnalyticsDashboardコンポーネントを拡張し、10の主要要件領域を実現します。

**実装アプローチ**: 既存コードの拡張（新規作成ではなく）、段階的な機能追加、早期の統合テスト

---

## 実装タスク

- [ ] 1. データベース基盤の構築
- [x] 1.1 キャッシュテーブルの作成と初期設定
  - analytics_cacheテーブルを作成（id, survey_id, metric_name, metric_data, category_filter, generated_at, expires_at）
  - サロゲートキーとユニーク制約を設定
  - survey_idとexpires_atに対するインデックスを作成
  - 外部キー制約でsurveys テーブルとの関連を定義（CASCADE DELETE）
  - _Requirements: 1.3, 8.1, 8.2_

- [x] 1.2 キャッシュ管理の基本機能実装
  - キャッシュエントリの挿入・更新機能（UPSERT）
  - TTL（24時間）の自動設定ロジック
  - 有効期限切れキャッシュのクリーンアップクエリ
  - キャッシュ無効化の基本メカニズム
  - _Requirements: 1.3, 1.4, 7.1_

- [x] 2. バックエンド分析サービスの強化
- [x] 2.1 調査サマリー生成機能の拡張
  - 総回答数の集計ロジック
  - 完了率の計算機能（目標回答数との比較）
  - カテゴリ別平均スコアの算出
  - 回答分布（スコア1-5の度数）の集計
  - キャッシュチェックと生成ロジックの統合
  - _Requirements: 1.1, 1.2, 1.3, 1.5_

- [x] 2.2 カテゴリ別分析機能の実装
  - 7つのカテゴリ（A-G）全体の分析データ取得
  - 特定カテゴリフィルタ適用時の絞り込み
  - 基本統計量の算出（平均、標準偏差、最小値、最大値、中央値、四分位数）
  - カテゴリ別分布グラフデータの生成
  - データ不足時のエラーハンドリング（3レスポンス未満）
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 2.3 トレンド分析機能の開発
  - 日次・週次・月次・四半期の期間選択対応
  - 期間ごとの平均スコアと回答数の集計
  - トレンド方向の判定ロジック（増加・減少・安定）
  - 変化率（％）の計算
  - 過去1年間のデータ制限ロジック
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_

- [x] 2.4 キャッシュ統合とパフォーマンス最適化
  - サマリー・カテゴリ分析・トレンドデータのキャッシュ保存
  - キャッシュヒット/ミスの判定ロジック
  - キャッシュ有効期限の確認メカニズム
  - useCacheパラメータの実装
  - パフォーマンスモニタリングログの追加
  - _Requirements: 1.3, 8.1, 8.2, 8.3_

- [ ] 3. レポート生成機能の実装
- [ ] 3.1 Excel形式レポート生成
  - ExcelJSライブラリを使用したワークブック作成
  - サマリーシートの生成（調査概要と主要指標）
  - カテゴリ別分析シートの生成
  - 回答詳細シートの生成（匿名性を保った形式）
  - セルスタイルとフォーマットの適用
  - _Requirements: 6.1, 6.2, 6.3, 6.5_

- [ ] 3.2 CSV形式レポート生成
  - fast-csvライブラリを使用したCSV生成
  - UTF-8エンコードの設定
  - ヘッダー定義と全レスポンスデータの出力
  - フィルタ条件の反映
  - ストリーミングAPIによる大量データ対応
  - _Requirements: 6.1, 6.2, 6.4, 6.5_

- [ ] 3.3 非同期レポート生成ジョブ管理
  - レポートジョブの作成とステータス管理（pending, processing, completed, failed）
  - ジョブIDの生成とトラッキング
  - バックグラウンド処理によるレポート生成
  - 生成完了後のファイルストレージへの保存
  - ダウンロードURLの生成
  - _Requirements: 6.1, 6.6_

- [ ] 3.4 レポートダウンロード機能
  - レポートステータス確認API
  - 完成したレポートのダウンロード提供
  - 適切なContent-TypeとContent-Dispositionヘッダー設定
  - エラー時の適切なレスポンス
  - _Requirements: 6.1_

- [x] 4. フロントエンド - ダッシュボード基盤
- [x] 4.1 AnalyticsDashboardコンポーネントの拡張
  - React Queryによるデータフェッチ設定（5分stale time）
  - ローディング状態の管理
  - エラーハンドリングとエラー表示
  - サマリーデータの取得とステート管理
  - レイアウトとサブコンポーネントの統合
  - _Requirements: 1.1, 7.2, 9.1, 9.2_

- [x] 4.2 サマリーカード表示コンポーネント
  - 総回答数の表示カード
  - 完了率の表示カード（進捗バー含む）
  - カテゴリ別平均スコアの表示
  - 回答分布の視覚的表現
  - カードデザインとレスポンシブレイアウト
  - _Requirements: 1.2, 1.5_

- [x] 5. フロントエンド - グラフ可視化
- [x] 5.1 ChartComponentsの拡張
  - レーダーチャートコンポーネント（全カテゴリスコア表示）
  - 棒グラフコンポーネント（回答分布、カテゴリ別スコア）
  - 折れ線グラフコンポーネント（トレンド分析）
  - Rechartsライブラリのインタラクティブ機能活用
  - グラフ共通のスタイルと設定
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [ ] 5.2 ツールチップとインタラクション機能
  - グラフデータポイントへのホバー時ツールチップ表示
  - 詳細数値の表示フォーマット
  - グラフ凡例の表示制御
  - データが存在しない場合のメッセージ表示
  - _Requirements: 3.5, 3.6_

- [ ] 5.3 カテゴリ分析表示コンポーネント
  - カテゴリ選択UI（全カテゴリ/個別カテゴリ）
  - 統計情報テーブルの表示（回答数、平均、標準偏差、最小・最大、中央値）
  - 分布ヒストグラムの表示
  - カテゴリコードとカテゴリ名の明示
  - データなし時のメッセージ表示
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

- [ ] 6. フロントエンド - フィルタとトレンド分析
- [ ] 6.1 FilterPanelコンポーネントの強化
  - 調査選択ドロップダウン
  - カテゴリ選択チェックボックス（A-G）
  - 期間選択（日次、週次、月次、四半期）
  - フィルタ適用時の全体更新トリガー
  - フィルタクリア機能
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ] 6.2 TrendAnalysisコンポーネントの実装
  - トレンドグラフの表示（折れ線グラフ）
  - 期間選択に応じたデータ更新
  - トレンド方向インジケーター（増加・減少・安定）
  - 変化率の表示
  - 特定カテゴリフィルタの適用
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_

- [ ] 7. フロントエンド - データエクスポート
- [ ] 7.1 ExportToolsコンポーネントの実装
  - エクスポート形式選択ダイアログ（Excel/CSV）
  - レポート生成リクエストの送信
  - ポーリングによるレポートステータス確認（3秒間隔）
  - 進捗インジケーターの表示
  - ダウンロード完了時の処理
  - _Requirements: 6.1, 6.2, 6.5, 6.6_

- [ ] 7.2 エクスポートエラーハンドリング
  - レポート生成失敗時のエラーメッセージ
  - タイムアウト処理
  - 再試行機能
  - ユーザーへのフィードバック
  - _Requirements: 9.1, 9.3, 9.4_

- [ ] 8. リアルタイム更新機能
- [ ] 8.1 自動データ更新機構
  - 5分間隔のデータ更新確認（React QueryのrefetchInterval）
  - キャッシュ無効化検知ロジック
  - 更新通知の表示
  - ユーザー承認後のダッシュボード再描画
  - _Requirements: 7.2, 7.3, 7.4, 7.5_

- [ ] 8.2 キャッシュ無効化トリガー統合
  - レスポンス追加時のキャッシュ無効化API呼び出し
  - ResponsesServiceとの統合
  - 該当調査のキャッシュクリア
  - _Requirements: 1.4, 7.1_

- [ ] 9. エラーハンドリングとユーザーフィードバック
- [ ] 9.1 バックエンドエラーハンドリング強化
  - データベース接続エラーの適切な処理
  - 不正な調査ID時の404エラーレスポンス
  - 集計処理エラーのログ記録と汎用メッセージ
  - タイムアウトエラー（10秒超過）の処理
  - _Requirements: 9.1, 9.2, 9.3, 8.5_

- [ ] 9.2 フロントエンドエラー表示
  - エラーメッセージの適切な表示
  - 再試行ボタンの提供
  - 3回失敗時のシステム管理者連絡促進メッセージ
  - ErrorBoundaryによるReactエラーキャッチ
  - _Requirements: 9.4, 9.5_

- [ ] 10. アクセス制御とセキュリティ
- [ ] 10.1 ルートガードの設定
  - /admin/analyticsパスへのHRRouteガード適用
  - 一般従業員アクセス時の403エラーとリダイレクト
  - 未認証ユーザーのログインページリダイレクト
  - _Requirements: 10.1, 10.2, 10.3, 10.4_

- [ ] 10.2 匿名性保証の実装
  - 最小集計単位（3レスポンス以上）のチェック
  - 個人特定可能なデータの除外
  - 集計結果のみのエクスポート確認
  - データ不足時の適切なメッセージ表示
  - _Requirements: 非機能要件 - セキュリティ_

- [ ] 11. パフォーマンス最適化とテスト
- [ ] 11.1 パフォーマンステスト
  - 初回ロード時間の測定（1000件レスポンスで3秒以内）
  - キャッシュヒット時のロード時間測定（1秒以内）
  - グラフ描画時間の測定（500ms以内）
  - 大量データエクスポートのパフォーマンステスト（10000行）
  - _Requirements: 8.1, 8.2, 8.3, 6.6_

- [ ] 11.2 単体テスト
  - AnalyticsService各メソッドのテスト（getSurveySummary, getCategoryAnalysis, getTrendAnalysis）
  - StatisticsUtil計算精度のテスト
  - ReportService レポート生成とジョブ管理のテスト
  - ChartComponents各グラフタイプのレンダリングテスト
  - FilterPanelフィルタ変更時のコールバックテスト
  - _Requirements: テスト戦略 - ユニットテスト_

- [ ] 11.3 統合テスト
  - GET /analytics/summary エンドツーエンドテスト（キャッシュ動作確認含む）
  - POST /analytics/reports/generate からダウンロードまでの完全フロー
  - キャッシュ無効化トリガーの検証
  - フィルタ適用時のAPI呼び出しとレスポンス整合性
  - _Requirements: テスト戦略 - 統合テスト_

- [ ] 11.4 E2Eテスト（Playwright）
  - ダッシュボードアクセスからサマリー表示までのユーザーフロー
  - フィルタ適用後のグラフ更新確認
  - トレンド分析の期間変更操作
  - Excelエクスポートからダウンロード完了までの操作
  - 不正な調査IDアクセス時の404エラー表示確認
  - _Requirements: テスト戦略 - E2E/UIテスト_

- [ ] 12. 統合と最終調整
- [ ] 12.1 コンポーネント統合とワイヤリング
  - すべてのフロントエンドコンポーネントの統合確認
  - App.tsxへのルート追加確認
  - バックエンドAPIルートの登録確認（index.ts）
  - データフローの検証（Frontend → Backend → Database → Cache）
  - _Requirements: 全要件の統合_

- [ ] 12.2 UI/UXの最終調整
  - レスポンシブデザインの確認（タブレット以上）
  - ローディングインジケーターの適切な表示
  - エラーメッセージの可読性確認
  - グラフの視覚的調整（色、フォント、レイアウト）
  - _Requirements: 非機能要件 - 互換性_

- [ ] 12.3 ドキュメントとログの整備
  - Pinoロガーによる構造化ログの確認
  - APIドキュメント（Swagger）の更新確認
  - コード内コメントの整備
  - エラーログのレベル設定確認
  - _Requirements: モニタリング_

---

## タスク実行ガイド

### 推奨実行順序
1. **データベース基盤（タスク1）**: 最初に実行し、キャッシュテーブルとメカニズムを確立
2. **バックエンドサービス（タスク2-3）**: データ処理とAPI機能を実装
3. **フロントエンド基盤（タスク4-7）**: UI コンポーネントとグラフ可視化
4. **リアルタイム更新（タスク8）**: キャッシュ戦略の完成
5. **エラーハンドリングとセキュリティ（タスク9-10）**: 堅牢性の向上
6. **テストと統合（タスク11-12）**: 品質保証と最終調整

### タスク完了基準
- 各サブタスクは1-3時間で完了可能
- 実装コードは動作確認済み
- 関連する単体テストが追加されている
- コードレビュー可能な状態

### 注意事項
- 既存のAnalyticsService、AnalyticsDashboard、ReportServiceは**拡張**すること（新規作成ではなく）
- 後方互換性を維持すること
- TypeScript strict modeを遵守
- Zodスキーマバリデーションを全APIで実施
