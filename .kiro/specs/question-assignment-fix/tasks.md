# 実装計画

## タスク概要
質問割り当て画面の2つの不具合を修正します：
1. 割り当て済み質問のカウント表示を削除
2. 質問順序変更時のエラーを解消し、エラーハンドリングを改善

## 実装タスク

- [x] 1. UI表示の修正：カウント表示の削除
- [x] 1.1 割り当て済み質問セクションの見出しを修正
  - 見出しテキストから質問数のカウント表示（例: "(2)"）を削除
  - 「割り当て済み質問」というテキストのみを表示するよう変更
  - 既存のスタイリングとレイアウトは維持
  - _Requirements: 1.1, 1.2, 1.3_

- [x] 2. エラーハンドリング機能の実装
- [x] 2.1 エラー判別ヘルパー関数を作成
  - エラーの種類を判別する機能を実装（ネットワークエラー、HTTPステータスコード別）
  - ネットワークエラー時の具体的なメッセージを返す
  - HTTPステータスコード（404, 422, 4xx, 5xx）に応じたメッセージを返す
  - 不明なエラーに対するフォールバックメッセージを提供
  - _Requirements: 3.1, 3.2, 3.3_

- [x] 2.2 状態管理機能を実装
  - 現在の状態のスナップショットを保存する機能を実装
  - 保存した状態を復元する機能を実装
  - 割り当て済み質問リストと利用可能な質問リストの両方を対象とする
  - イミュータブルな状態管理を確保
  - _Requirements: 3.4_

- [x] 3. ドラッグ&ドロップ処理の改善
- [x] 3.1 質問順序変更時の楽観的UI更新とロールバックを実装
  - ドロップ操作開始時に状態スナップショットを保存
  - UIを即座に更新（楽観的UI）
  - 順序変更の判定ロジックを実装（isReordering）
  - 質問の順序番号（order_num）を再計算
  - _Requirements: 2.1, 2.3, 4.2, 4.3_

- [x] 3.2 API呼び出しとエラーハンドリングを統合
  - 順序変更時に適切なAPI関数を呼び出し
  - API成功時の処理を実装
  - APIエラー時に状態をロールバック
  - エラーメッセージを具体的に表示
  - _Requirements: 2.2, 2.4, 2.5, 3.1, 3.2, 3.3, 3.4_

- [x] 3.3 新規質問割り当て処理の整合性を確保
  - 利用可能リストから割り当てリストへの移動を正確に処理
  - 質問を利用可能リストから削除し、割り当てリストに追加
  - バックエンドAPIに正しい質問IDリストを送信
  - エラー時の状態ロールバックを実装
  - _Requirements: 4.1, 4.4_

- [ ] 4. テストの実装
- [ ] 4.1 ユニットテストを作成
  - エラー判別関数のテスト（各エラータイプのメッセージ生成）
  - 状態スナップショット機能のテスト（保存と復元）
  - 順序変更ロジックのテスト（order_num再計算、isReordering判定）
  - _Requirements: 全要件のロジック検証_

- [ ] 4.2 統合テストを作成
  - 質問順序変更の成功フローをテスト
  - ネットワークエラー発生時のロールバックをテスト
  - バリデーションエラー発生時のロールバックをテスト
  - 新規質問割り当ての成功フローをテスト
  - _Requirements: 2.1-2.5, 3.1-3.4, 4.1-4.4_

- [ ] 4.3 E2E/UIテストを作成
  - 割り当て済み質問の見出し表示を検証（カウント表示なし）
  - 質問順序変更の完全なユーザーフローをテスト
  - エラー発生時のユーザー体験をテスト（エラーメッセージ表示と状態復元）
  - 複数質問の連続的な順序変更をテスト
  - _Requirements: 1.1-1.3, 2.1-2.5, 3.1-3.4_

## 要件カバレッジ確認

### Requirement 1: 割り当て済み質問カウント表示の削除
- ✅ タスク 1.1: 見出しテキストの修正
- ✅ タスク 4.3: E2Eテストで表示検証

### Requirement 2: 質問順序変更機能の修正
- ✅ タスク 3.1: 楽観的UI更新とロールバック
- ✅ タスク 3.2: API呼び出しとエラーハンドリング
- ✅ タスク 4.2, 4.3: 統合テストとE2Eテスト

### Requirement 3: エラーハンドリングの改善
- ✅ タスク 2.1: エラー判別機能
- ✅ タスク 2.2: 状態管理機能
- ✅ タスク 3.2: エラー時のロールバック統合
- ✅ タスク 4.1, 4.2: ユニットテストと統合テスト

### Requirement 4: ドラッグ&ドロップ機能の整合性確保
- ✅ タスク 3.1: 順序変更の判定と処理
- ✅ タスク 3.3: 新規質問割り当ての処理
- ✅ タスク 4.2, 4.3: 統合テストとE2Eテスト

## 実装順序の理由

1. **タスク1**: UI修正は独立しており、影響範囲が小さいため最初に実装
2. **タスク2**: エラーハンドリングの基礎機能を先に実装し、後続タスクで活用
3. **タスク3**: エラーハンドリング機能を活用して、ドラッグ&ドロップ処理を改善
4. **タスク4**: 全機能実装後にテストを追加し、品質を保証

## 注意事項

- 既存のドラッグ&ドロップ実装を最大限活用し、不要なリファクタリングを避ける
- 楽観的UIを維持しつつ、エラー時の整合性を確保
- バックエンドAPIの動作を前提とし、APIエンドポイントの変更は行わない
- テストは段階的に追加し、各機能の動作を確認しながら進める
