# 実装計画

## 概要

調査詳細参照機能の実装タスクです。既存のSurveyDetailPageコンポーネントを拡張し、質問プレビュー機能と回答状態管理機能を追加します。完全匿名性を維持しながら、従業員が調査の全体像を把握してから回答を開始できるようにします。

## 実装タスク

- [ ] 1. セッション管理機能の拡張
- [ ] 1.1 回答状態管理機能の実装
  - LocalStorageベースの完了済み調査管理機能を実装
  - 調査完了状態の確認機能を追加
  - 完了情報の保存・取得機能を実装
  - 完了済み調査リストの管理機能を追加
  - _Requirements: 3.1, 3.2, 3.5_

- [ ] 1.2 完了情報の検証とクリーンアップ機能
  - 完了情報の形式検証機能を実装
  - 古い完了情報の自動削除機能を追加（90日以上前）
  - LocalStorage容量管理機能を実装（最大1000件）
  - エラー処理とフォールバック機能を追加
  - _Requirements: 3.1, 7.3_

- [ ] 2. 質問プレビューコンポーネントの実装
- [ ] 2.1 基本的な質問表示機能
  - 質問リスト表示コンポーネントを新規作成
  - 質問文と質問タイプの表示機能を実装
  - 必須・任意の区別表示機能を追加
  - 空配列の適切な処理を実装
  - _Requirements: 2.1, 2.2_

- [ ] 2.2 質問タイプ別の詳細表示機能
  - 多肢選択式質問の選択肢表示機能を実装
  - 評価スケール質問の範囲表示機能を追加
  - Yes/No質問の表示機能を実装
  - 自由記述質問の入力形式表示を追加
  - _Requirements: 2.2, 2.4_

- [ ] 2.3 カテゴリ分類と折りたたみ機能
  - カテゴリごとの質問グループ化機能を実装
  - カテゴリ別の折りたたみ・展開機能を追加
  - 10問超過時の自動折りたたみ機能を実装
  - 全カテゴリの一括展開・折りたたみ機能を追加
  - _Requirements: 2.3, 2.5_

- [ ] 3. 調査詳細ページの拡張
- [ ] 3.1 質問データ取得機能の追加
  - 調査情報と質問情報の並行取得機能を実装
  - APIレスポンスのZodスキーマ検証を追加
  - エラーハンドリングとローディング状態管理を実装
  - データ統合とstate更新機能を追加
  - _Requirements: 8.1, 8.2, 8.3, 8.4_

- [ ] 3.2 推定所要時間の計算と表示機能
  - 質問数に基づく所要時間計算ロジックを実装
  - 所要時間の表示フォーマット機能を追加（分単位）
  - 質問タイプ別の時間係数設定を実装
  - 所要時間のUI表示機能を追加
  - _Requirements: 1.4_

- [ ] 3.3 期限強調表示機能
  - 期限までの残り日数計算機能を実装
  - 3日以内の場合の視覚的強調表示を追加
  - 期限切れの場合の表示機能を実装
  - バッジやアイコンによる視覚的フィードバックを追加
  - _Requirements: 1.5_

- [ ] 3.4 回答状態の表示とボタン制御
  - LocalStorageからの回答状態確認機能を実装
  - 回答済み状態の表示UI を追加
  - 回答完了日時の表示機能を実装
  - 回答開始ボタンの条件付き表示・無効化機能を追加
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [ ] 4. ページレイアウトとUI統合
- [ ] 4.1 調査詳細セクションの再構成
  - 既存の基本情報表示を維持しつつレイアウト調整
  - 質問プレビューセクションの追加と配置
  - 回答状態セクションの追加と配置
  - レスポンシブレイアウトの実装（モバイル・タブレット・デスクトップ）
  - _Requirements: 1.1, 1.2, 1.3, 6.1, 6.2, 6.3_

- [ ] 4.2 アクセシビリティ対応
  - セマンティックHTML要素の適切な使用
  - ARIAラベルの追加（ボタン、リンク、セクション）
  - キーボードナビゲーションの実装と検証
  - スクリーンリーダー対応の実装
  - _Requirements: 6.4, 6.5_

- [ ] 5. ナビゲーションと回答開始機能
- [ ] 5.1 回答開始フローの実装
  - 回答開始ボタンのクリックハンドラー実装
  - 回答済みチェックとアラート表示機能
  - 回答ページへのルーティング機能を実装
  - ページ状態の保持機能を追加
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [ ] 5.2 ナビゲーションリンクの実装
  - 調査一覧への戻るリンク機能を実装
  - パンくずナビゲーションの追加（オプション）
  - リンクのアクセシビリティ対応
  - ナビゲーション状態の視覚的フィードバック
  - _Requirements: 5.2, 5.3_

- [ ] 6. エラーハンドリングとユーザーフィードバック
- [ ] 6.1 API エラーハンドリング
  - 404エラー時の適切な表示とリカバリーオプション
  - 500エラー時の再試行機能とエラーメッセージ
  - ネットワークエラー時の適切な表示
  - エラーログ記録機能の実装
  - _Requirements: 7.3, 7.4, 7.5, 5.5_

- [ ] 6.2 ローディング状態とフィードバック
  - ローディングインジケータの表示機能
  - スケルトンスクリーンの実装（オプション）
  - データ取得中の適切なUI状態管理
  - 並行データ取得中のローディング表示
  - _Requirements: 7.2_

- [ ] 7. テストの実装
- [ ] 7.1 ユニットテストの作成
  - SessionUtils拡張機能のテスト実装
  - QuestionPreviewListコンポーネントのテスト実装
  - SurveyDetailPage拡張機能のテスト実装
  - エッジケースとエラーケースのテスト追加
  - _Requirements: 全要件_

- [ ] 7.2 統合テストの作成
  - API統合テストの実装
  - ナビゲーション統合テストの実装
  - LocalStorage統合テストの実装
  - エラーハンドリング統合テストの実装
  - _Requirements: 全要件_

- [ ] 7.3 E2Eテストの作成
  - 調査詳細閲覧フローのテスト実装
  - 回答開始フローのテスト実装
  - エラーハンドリングフローのテスト実装
  - レスポンシブデザインのテスト実装
  - _Requirements: 全要件_

- [ ] 8. パフォーマンス最適化
- [ ] 8.1 レンダリング最適化
  - React.memoによるコンポーネントメモ化
  - useMemoによる計算結果キャッシュ
  - 質問リストの仮想化（100問超過時、オプション）
  - 不要な再レンダリングの防止
  - _Requirements: 7.1_

- [ ] 8.2 データ取得最適化
  - Promise.allによる並行データ取得の検証
  - APIレスポンス時間の計測と最適化
  - エラー時のリトライ戦略実装（指数バックオフ）
  - パフォーマンスメトリクスの記録
  - _Requirements: 7.1, 8.5_

## タスク実行順序

1. **フェーズ1: 基盤機能** (タスク1)
   - セッション管理機能の拡張を最初に実装

2. **フェーズ2: UI コンポーネント** (タスク2)
   - 質問プレビューコンポーネントを独立して実装

3. **フェーズ3: ページ統合** (タスク3-4)
   - 調査詳細ページに新機能を統合

4. **フェーズ4: 機能完成** (タスク5-6)
   - ナビゲーションとエラーハンドリングを実装

5. **フェーズ5: 品質保証** (タスク7-8)
   - テストとパフォーマンス最適化を実施

## 注意事項

- 既存のSurveyDetailPageコンポーネントを壊さないよう注意
- 完全匿名性を維持するため、個人情報をLocalStorageに保存しない
- Tailwind CSSの既存スタイリングパターンに準拠
- TypeScriptの厳格な型チェックを遵守
- 各タスク完了後にユニットテストを実行して動作確認
