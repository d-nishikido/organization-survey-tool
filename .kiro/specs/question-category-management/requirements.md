# 要件定義書 (Requirements Document)

## はじめに

質問カテゴリ管理機能は、組織改善ツールにおける調査カテゴリ（A-G: 仕事について、最近の状態について等）の作成・編集・削除を担う管理機能です。HR担当者が調査の目的に応じて柔軟にカテゴリを管理し、質問を適切に分類することで、より効果的な組織診断を実現します。

現在、システムには7つの固定カテゴリ（A-G）が`survey_categories`テーブルに存在しており、各カテゴリにはコード、名称、説明、表示順序、有効/無効フラグが設定されています。本機能により、これらのカテゴリの管理UIを提供し、HR担当者が組織の状況に応じてカテゴリをカスタマイズできるようにします。

## 要件

### 要件1: カテゴリ一覧表示

**目的:** HR担当者として、既存の全カテゴリを一覧形式で確認したい。そうすることで、現在のカテゴリ構成を把握し、編集や削除の判断ができる。

#### 受入基準

1. WHEN HR担当者がカテゴリ管理画面にアクセスする THEN システムは全カテゴリを表示順序でソートして表示する
2. WHERE カテゴリ一覧 THE システムは以下の情報をテーブル形式で表示する:
   - カテゴリコード（A-G）
   - カテゴリ名
   - 説明
   - 表示順序
   - 有効/無効ステータス
   - 関連質問数
3. WHEN カテゴリが無効化されている THEN システムは視覚的に区別できる表示（グレーアウト等）を適用する
4. IF カテゴリに関連する質問が存在する THEN システムは質問数をバッジ表示する
5. WHERE 一覧表示 THE システムは各カテゴリ行に編集・削除アクションボタンを配置する

### 要件2: カテゴリ作成

**目的:** HR担当者として、新しいカテゴリを作成したい。そうすることで、組織固有の調査観点を追加できる。

#### 受入基準

1. WHEN HR担当者が「新規カテゴリ作成」ボタンをクリックする THEN システムはカテゴリ作成フォームを表示する
2. WHERE カテゴリ作成フォーム THE システムは以下の入力項目を提供する:
   - カテゴリコード（必須、1-3文字、英数字）
   - カテゴリ名（必須、最大50文字）
   - 説明（任意、最大200文字）
   - 表示順序（必須、数値）
   - 有効/無効フラグ（デフォルト: 有効）
3. WHEN HR担当者がカテゴリコードを入力する AND そのコードが既に存在する THEN システムは「既に使用されているコードです」エラーを表示する
4. WHEN 全ての必須項目が入力されている AND バリデーションが成功する THEN システムは「作成」ボタンを有効化する
5. WHEN HR担当者が「作成」ボタンをクリックする THEN システムは新カテゴリをデータベースに保存し、一覧画面に遷移する
6. IF 作成処理が成功する THEN システムは「カテゴリを作成しました」成功メッセージを表示する

### 要件3: カテゴリ編集

**目的:** HR担当者として、既存カテゴリの情報を更新したい。そうすることで、組織の変化に応じてカテゴリ定義を最新化できる。

#### 受入基準

1. WHEN HR担当者がカテゴリ行の編集ボタンをクリックする THEN システムは編集フォームを表示し、現在の値を初期表示する
2. WHERE 編集フォーム THE システムはカテゴリコード以外の全項目の編集を許可する
3. WHEN HR担当者がカテゴリ名を空白にする THEN システムは「カテゴリ名は必須です」バリデーションエラーを表示する
4. WHEN HR担当者が表示順序を他カテゴリと重複する値に変更する THEN システムは警告メッセージを表示するが保存は許可する
5. WHEN HR担当者が「保存」ボタンをクリックする AND バリデーションが成功する THEN システムは変更をデータベースに反映し、一覧画面に遷移する
6. IF 更新処理が成功する THEN システムは「カテゴリを更新しました」成功メッセージを表示する

### 要件4: カテゴリ削除

**目的:** HR担当者として、不要なカテゴリを削除したい。そうすることで、カテゴリ一覧を整理し、運用しやすくできる。

#### 受入基準

1. WHEN HR担当者がカテゴリ行の削除ボタンをクリックする THEN システムは削除確認ダイアログを表示する
2. WHERE 削除確認ダイアログ THE システムは削除対象カテゴリ名と影響範囲を明示する
3. IF 削除対象カテゴリに関連する質問が存在する THEN システムは「このカテゴリには○件の質問が関連しています。削除すると質問のカテゴリ参照がNULLになります」警告を表示する
4. WHEN HR担当者が削除を確定する THEN システムはカテゴリをデータベースから物理削除する
5. IF 削除対象カテゴリに関連質問がある THEN システムは関連質問の`category_id`をNULLに更新する（ON DELETE SET NULL制約による）
6. IF 削除処理が成功する THEN システムは「カテゴリを削除しました」成功メッセージを表示し、一覧を更新する

### 要件5: カテゴリ有効/無効切り替え

**目的:** HR担当者として、カテゴリを削除せずに一時的に無効化したい。そうすることで、将来的な再利用の可能性を残しつつ、現在の調査では使用しないカテゴリを除外できる。

#### 受入基準

1. WHEN HR担当者がカテゴリ一覧で有効/無効トグルスイッチをクリックする THEN システムは即座にステータスを反転する
2. WHERE ステータス変更 THE システムはデータベースの`is_active`フィールドを更新する
3. IF カテゴリが無効化される THEN システムはそのカテゴリをグレーアウト表示し、「無効」ラベルを付与する
4. WHEN 無効化されたカテゴリに関連する質問が存在する THEN システムは警告アイコンを表示する
5. IF カテゴリが再度有効化される THEN システムは通常表示に戻し、「有効」ラベルを付与する

### 要件6: カテゴリ並び替え

**目的:** HR担当者として、カテゴリの表示順序を変更したい。そうすることで、調査画面での質問の流れを最適化できる。

#### 受入基準

1. WHEN HR担当者がカテゴリ行をドラッグする THEN システムはドラッグ中の視覚的フィードバックを提供する
2. WHEN HR担当者がカテゴリを別の位置にドロップする THEN システムは表示順序を再計算する
3. WHERE 並び替え処理 THE システムは影響を受ける全カテゴリの`display_order`を更新する
4. IF 並び替えが成功する THEN システムは新しい順序で一覧を再描画する
5. WHEN 並び替え処理中にエラーが発生する THEN システムは元の順序に戻し、エラーメッセージを表示する

### 要件7: カテゴリ検索・フィルタリング

**目的:** HR担当者として、特定の条件でカテゴリを絞り込みたい。そうすることで、多数のカテゴリの中から目的のものを素早く見つけられる。

#### 受入基準

1. WHEN HR担当者が検索ボックスにテキストを入力する THEN システムはカテゴリコード、名称、説明に対して部分一致検索を実行する
2. WHERE 検索結果 THE システムはマッチしたカテゴリのみを表示する
3. WHEN HR担当者が「有効のみ」フィルタを適用する THEN システムは`is_active = true`のカテゴリのみを表示する
4. WHEN HR担当者が「無効のみ」フィルタを適用する THEN システムは`is_active = false`のカテゴリのみを表示する
5. IF 検索・フィルタ結果が0件 THEN システムは「条件に一致するカテゴリがありません」メッセージを表示する

### 要件8: カテゴリ使用状況の表示

**目的:** HR担当者として、各カテゴリがどの調査・質問で使用されているか確認したい。そうすることで、削除や変更の影響範囲を事前に把握できる。

#### 受入基準

1. WHEN HR担当者がカテゴリ行の詳細ボタンをクリックする THEN システムはカテゴリ詳細パネルを表示する
2. WHERE カテゴリ詳細パネル THE システムは以下の情報を表示する:
   - カテゴリ基本情報（コード、名称、説明、ステータス）
   - 関連質問数
   - 関連質問リスト（最大10件、それ以上は「さらに表示」）
   - 最終更新日時
3. IF カテゴリに関連質問がない THEN システムは「このカテゴリには関連する質問がありません」メッセージを表示する
4. WHEN 関連質問リストで質問をクリックする THEN システムは質問管理画面の該当質問に遷移する

### 要件9: バリデーション

**目的:** システム管理者として、データの整合性を保証するバリデーションを実装したい。そうすることで、不正なデータの登録を防止できる。

#### 受入基準

1. WHEN HR担当者がカテゴリコードに特殊文字を入力する THEN システムは「英数字のみ使用可能です」エラーを表示する
2. WHEN HR担当者がカテゴリ名に51文字以上を入力する THEN システムは「50文字以内で入力してください」エラーを表示する
3. WHEN HR担当者が説明欄に201文字以上を入力する THEN システムは「200文字以内で入力してください」エラーを表示する
4. WHEN HR担当者が表示順序に負の数値を入力する THEN システムは「1以上の数値を入力してください」エラーを表示する
5. IF 複数のバリデーションエラーが存在する THEN システムは全てのエラーを同時に表示する

### 要件10: API エンドポイント

**目的:** システムとして、フロントエンドからのカテゴリ操作を受け付けるRESTful APIを提供したい。そうすることで、UI層とビジネスロジック層を適切に分離できる。

#### 受入基準

1. WHERE カテゴリAPI THE システムは以下のエンドポイントを提供する:
   - GET /api/categories - カテゴリ一覧取得
   - GET /api/categories/:id - カテゴリ詳細取得
   - POST /api/categories - カテゴリ作成
   - PUT /api/categories/:id - カテゴリ更新
   - DELETE /api/categories/:id - カテゴリ削除
   - PATCH /api/categories/:id/status - 有効/無効切り替え
   - PATCH /api/categories/reorder - 並び替え
2. WHEN GET /api/categories が呼ばれる THEN システムは全カテゴリを表示順序でソートしてJSON形式で返却する
3. WHEN POST /api/categories が呼ばれる AND リクエストボディが不正 THEN システムは400 Bad Requestとバリデーションエラー詳細を返却する
4. WHEN DELETE /api/categories/:id が呼ばれる AND 該当カテゴリが存在しない THEN システムは404 Not Foundを返却する
5. WHERE 全APIエンドポイント THE システムはZodスキーマによる入力バリデーションを実行する

## 非機能要件

### パフォーマンス
- カテゴリ一覧取得: 500ms以内（100件のカテゴリ）
- カテゴリ作成・更新・削除: 1秒以内

### スケーラビリティ
- 最大100カテゴリをサポート
- 同時編集ユーザー数: 5人（HR担当者）

### セキュリティ
- アクセス制御: HR担当者およびシステム管理者のみアクセス可能
- 入力サニタイゼーション: XSS攻撃対策
- SQLインジェクション対策: パラメータ化クエリ

### 互換性
- サポートブラウザ: Chrome 最新版、Edge 最新版、Firefox 最新版
- レスポンシブデザイン: デスクトップ優先（タブレット対応）

### データ整合性
- カテゴリ削除時: 関連質問の`category_id`をNULLに設定（ON DELETE SET NULL）
- トランザクション管理: 並び替え等の複数行更新は単一トランザクションで実行
