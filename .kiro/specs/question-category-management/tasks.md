# 実装タスク

## 概要

本ドキュメントは、質問カテゴリ管理機能の実装タスクを定義します。各タスクは要件定義書（requirements.md）と技術設計書（design.md）に基づいており、実装の詳細は設計書を参照してください。

## タスク一覧

- [x] 1. データアクセス層の実装
- [x] 1.1 カテゴリデータアクセスの基盤構築
  - カテゴリデータの取得・検索機能を実装
  - カテゴリコードによる重複チェック機能を実装
  - 有効なカテゴリのみを取得するフィルタ機能を実装
  - カテゴリに関連する質問数をカウントする機能を実装
  - _Requirements: 1.1, 1.2, 7.1, 7.2, 8.2_

- [x] 1.2 カテゴリ作成・更新機能の実装
  - 新規カテゴリをデータベースに登録する機能を実装
  - 既存カテゴリの情報を更新する機能を実装
  - カテゴリの有効/無効ステータスを切り替える機能を実装
  - デフォルト値の適用（is_active=true）を実装
  - _Requirements: 2.1, 2.5, 3.1, 3.5, 5.1, 5.2_

- [x] 1.3 カテゴリ削除機能の実装
  - カテゴリをデータベースから物理削除する機能を実装
  - 削除前に関連質問数を確認する機能を実装
  - ON DELETE SET NULL制約の動作を検証
  - _Requirements: 4.1, 4.4, 4.5_

- [x] 1.4 カテゴリ並び替え機能の実装
  - 複数カテゴリの表示順序を一括更新する機能を実装
  - トランザクション内での更新処理を実装（全成功または全失敗）
  - エラー時の自動ロールバック処理を実装
  - _Requirements: 6.2, 6.3, 6.5_

- [x] 2. ビジネスロジック層の実装
- [x] 2.1 カテゴリ一覧・詳細取得ロジック
  - 全カテゴリを表示順序でソートして取得するロジックを実装
  - カテゴリIDによる詳細情報取得ロジックを実装
  - 関連質問数を含むカテゴリ情報の組み立てを実装
  - _Requirements: 1.1, 1.2, 8.1, 8.2_

- [x] 2.2 カテゴリ作成ロジックとバリデーション
  - カテゴリコードの重複チェックロジックを実装
  - コード重複時のビジネスエラー（409 Conflict）処理を実装
  - 新規カテゴリ作成の完全なビジネスフローを実装
  - _Requirements: 2.2, 2.3, 2.5, 2.6_

- [x] 2.3 カテゴリ更新・削除ロジック
  - カテゴリ存在確認とNotFoundエラー処理を実装
  - カテゴリ更新の完全なビジネスフローを実装
  - 削除時の関連質問数警告ロギングを実装
  - _Requirements: 3.3, 3.5, 3.6, 4.2, 4.3, 4.6_

- [x] 2.4 並び替え・ステータス切り替えロジック
  - 並び替え時の不正IDチェックとエラー処理を実装
  - 有効/無効ステータス切り替えロジックを実装
  - ステータス変更時の警告表示ロジックを実装
  - _Requirements: 5.3, 5.4, 5.5, 6.1, 6.4_

- [x] 3. API層の実装
- [x] 3.1 カテゴリ取得APIエンドポイント
  - GET /api/categories エンドポイントを実装
  - GET /api/categories/:id エンドポイントを実装
  - クエリパラメータによる有効カテゴリフィルタを実装
  - Zodスキーマによる入力バリデーションを実装
  - _Requirements: 10.1, 10.2_

- [x] 3.2 カテゴリ作成・更新APIエンドポイント
  - POST /api/categories エンドポイントを実装
  - PUT /api/categories/:id エンドポイントを実装
  - リクエストボディのZodバリデーション（code, name, description等）を実装
  - バリデーションエラー時の詳細エラーレスポンス（400）を実装
  - _Requirements: 2.1, 2.2, 3.1, 9.1, 9.2, 9.3, 10.3_

- [x] 3.3 カテゴリ削除・ステータス変更APIエンドポイント
  - DELETE /api/categories/:id エンドポイントを実装
  - PATCH /api/categories/:id/status エンドポイントを実装
  - 存在しないIDに対する404エラーレスポンスを実装
  - 成功時の適切なHTTPステータスコード（204, 200）を返却
  - _Requirements: 4.1, 5.1, 10.1, 10.4_

- [x] 3.4 カテゴリ並び替えAPIエンドポイント
  - PATCH /api/categories/reorder エンドポイントを実装
  - orderedIds配列のZodバリデーションを実装
  - 不正ID時の422エラーレスポンスを実装
  - _Requirements: 6.1, 6.2, 10.1, 10.5_

- [ ] 4. フロントエンド - カテゴリ一覧画面の実装
- [ ] 4.1 カテゴリ一覧テーブルコンポーネント
  - カテゴリ情報をテーブル形式で表示する機能を実装
  - コード、名称、説明、表示順序、ステータス、関連質問数の表示を実装
  - 無効カテゴリのグレーアウト表示を実装
  - 各カテゴリ行に編集・削除アクションボタンを配置
  - _Requirements: 1.2, 1.3, 1.5_

- [ ] 4.2 検索・フィルタリング機能
  - カテゴリコード、名称、説明の部分一致検索を実装
  - 有効/無効フィルタの切り替え機能を実装
  - 検索結果0件時のメッセージ表示を実装
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_

- [ ] 4.3 ドラッグ&ドロップ並び替え機能
  - React DnDを使用したドラッグ&ドロップUIを実装
  - ドラッグ中の視覚的フィードバックを実装
  - ドロップ時の順序再計算とAPI呼び出しを実装
  - 並び替え成功時の一覧再描画を実装
  - _Requirements: 6.1, 6.2, 6.4_

- [ ] 4.4 有効/無効トグルスイッチ
  - ステータス切り替えトグルスイッチUIを実装
  - クリック時の即座なステータス反転とAPI呼び出しを実装
  - 無効化時の警告アイコン表示（関連質問ありの場合）を実装
  - _Requirements: 5.1, 5.3, 5.4, 5.5_

- [ ] 5. フロントエンド - カテゴリ作成・編集機能の実装
- [ ] 5.1 カテゴリ作成モーダルフォーム
  - 新規作成用モーダルダイアログを実装
  - React Hook Formによるフォーム管理を実装
  - コード、名称、説明、表示順序、有効/無効フラグの入力項目を実装
  - Zodリゾルバによるクライアント側バリデーションを実装
  - _Requirements: 2.1, 2.2, 9.1, 9.2, 9.3, 9.4_

- [ ] 5.2 カテゴリ編集モーダルフォーム
  - 編集用モーダルダイアログを実装
  - 現在の値をフォームに初期表示する機能を実装
  - カテゴリコード以外の項目の編集を許可
  - バリデーションエラーの表示機能を実装
  - _Requirements: 3.1, 3.2, 3.3, 9.5_

- [ ] 5.3 フォーム送信とエラーハンドリング
  - 作成・更新APIへのフォーム送信処理を実装
  - コード重複エラー（409）のトーストメッセージ表示を実装
  - バリデーションエラーのフィールド別ハイライト表示を実装
  - 成功時のトーストメッセージと一覧画面遷移を実装
  - _Requirements: 2.3, 2.6, 3.4, 3.6_

- [ ] 6. フロントエンド - カテゴリ削除・詳細機能の実装
- [ ] 6.1 削除確認ダイアログ
  - 削除確認ダイアログを実装
  - 削除対象カテゴリ名と影響範囲の表示を実装
  - 関連質問がある場合の警告メッセージ表示を実装
  - 削除確定時のAPI呼び出しと一覧更新を実装
  - _Requirements: 4.1, 4.2, 4.3, 4.6_

- [ ] 6.2 カテゴリ詳細パネル
  - カテゴリ詳細情報パネルを実装
  - カテゴリ基本情報、関連質問数、最終更新日時の表示を実装
  - 関連質問リスト（最大10件）の表示を実装
  - 質問クリック時の質問管理画面への遷移を実装
  - _Requirements: 8.1, 8.2, 8.3, 8.4_

- [ ] 7. 状態管理とAPI統合
- [ ] 7.1 React Queryによるサーバー状態管理
  - カテゴリ一覧取得のReact Queryフック実装
  - staleTime 5分のキャッシュ戦略を実装
  - 楽観的更新（作成、更新、削除時）を実装
  - _Requirements: 全要件（データ取得・更新）_

- [ ] 7.2 API通信層の実装
  - Axiosベースのカテゴリ API クライアントを実装
  - 全エンドポイント（GET, POST, PUT, DELETE, PATCH）のAPI関数を実装
  - エラーレスポンスのハンドリングとユーザーフレンドリーなエラーメッセージ変換を実装
  - _Requirements: 10.1, 10.2, 10.3, 10.4, 10.5_

- [ ] 8. ユニットテストの実装
- [ ] 8.1 Repository層のユニットテスト
  - findAll()の全カテゴリ取得・ソート検証テストを実装
  - findByCode()のコード検索・null返却テストを実装
  - create()のデフォルト値検証テストを実装
  - reorder()のトランザクション・ロールバックテストを実装
  - countRelatedQuestions()の関連質問数カウントテストを実装
  - _Requirements: 1.1, 2.5, 4.5, 6.3, 8.2_

- [ ] 8.2 Service層のユニットテスト
  - createCategory()のコード重複409エラーテストを実装
  - deleteCategory()のNotFoundエラー・警告ログテストを実装
  - reorderCategories()の不正ID422エラーテストを実装
  - toggleCategoryStatus()のis_activeフラグ反転テストを実装
  - ビジネスロジックバリデーションテストを実装
  - _Requirements: 2.3, 4.2, 5.2, 6.5, 9.1-9.5_

- [ ] 9. 統合テストの実装
- [ ] 9.1 カテゴリ作成・取得APIの統合テスト
  - POST /api/categories の正常作成（201）テストを実装
  - バリデーションエラー（400）テストを実装
  - コード重複エラー（409）テストを実装
  - GET /api/categories の全カテゴリ取得テストを実装
  - active_filterクエリパラメータ動作テストを実装
  - _Requirements: 2.1-2.6, 10.1, 10.2, 10.3_

- [ ] 9.2 カテゴリ更新・削除APIの統合テスト
  - PUT /api/categories/:id の正常更新（200）テストを実装
  - 存在しないID（404）テストを実装
  - DELETE /api/categories/:id の削除成功テストを実装
  - 関連質問ありの削除・外部キー制約動作テストを実装
  - _Requirements: 3.1-3.6, 4.1-4.6, 10.1, 10.4_

- [ ] 9.3 並び替え・ステータス変更APIの統合テスト
  - PATCH /api/categories/reorder のトランザクション成功テストを実装
  - 並び替え失敗時のロールバック動作テストを実装
  - PATCH /api/categories/:id/status のステータス切り替えテストを実装
  - _Requirements: 5.1-5.5, 6.1-6.5, 10.1, 10.5_

- [ ] 10. E2Eテストの実装
- [ ] 10.1 カテゴリ一覧画面のE2Eテスト
  - カテゴリ一覧テーブル表示テストを実装
  - ソート機能・有効/無効フィルタテストを実装
  - 検索機能（部分一致）テストを実装
  - _Requirements: 1.1-1.5, 7.1-7.5_

- [ ] 10.2 カテゴリ作成・編集フローのE2Eテスト
  - 作成フロー（モーダル表示→入力→作成成功→一覧更新）テストを実装
  - 編集フロー（編集ボタン→フォーム初期値→更新→一覧反映）テストを実装
  - バリデーションエラー表示（フィールド別エラー、赤色ボーダー）テストを実装
  - _Requirements: 2.1-2.6, 3.1-3.6, 9.1-9.5_

- [ ] 10.3 カテゴリ削除・並び替えフローのE2Eテスト
  - 削除フロー（削除ボタン→確認ダイアログ→削除実行→一覧更新）テストを実装
  - ドラッグ&ドロップ並び替え（ドラッグ→ドロップ→API呼び出し→再描画）テストを実装
  - ネットワークエラー時のリトライボタン表示テストを実装
  - _Requirements: 4.1-4.6, 6.1-6.5_

- [ ] 11. パフォーマンステストとエラーハンドリング
- [ ] 11.1 パフォーマンス目標の検証
  - カテゴリ一覧取得（100件）500ms以内の検証テストを実装
  - カテゴリ作成・更新1秒以内の検証テストを実装
  - 並び替え（50件）1秒以内の検証テストを実装
  - 同時5ユーザーの負荷テストを実装
  - _Requirements: 非機能要件（パフォーマンス）_

- [ ] 11.2 エラーハンドリングとロギングの実装
  - システムエラー（500）の汎用メッセージ表示とサーバーログ記録を実装
  - ビジネスエラー（409, 422）の詳細メッセージ表示を実装
  - Pinoロガーによる構造化ログ記録（ERROR, WARN, INFO）を実装
  - 操作ログ（作成、更新、削除）の記録を実装
  - _Requirements: エラーハンドリング、セキュリティ（監査ログ）_

- [ ] 12. ルーティングとアクセス制御の統合
- [ ] 12.1 管理画面ルーティングの追加
  - /admin/categories パスのルート定義をApp.tsxに追加
  - CategoryManagementページコンポーネントをルーティングに統合
  - ナビゲーションメニューにカテゴリ管理リンクを追加
  - _Requirements: 全要件（UI統合）_

- [ ] 12.2 認証・認可の統合
  - HR担当者権限チェックミドルウェアをAPIルートに適用
  - フロントエンドのProtectedRouteガードを実装
  - 未認証時のリダイレクト処理を実装
  - _Requirements: セキュリティ（アクセス制御）_

## 実装順序の推奨

1. **フェーズ1（基盤）**: タスク1（データアクセス層）→ タスク2（ビジネスロジック層）→ タスク3（API層）
2. **フェーズ2（UI）**: タスク4（一覧画面）→ タスク5（作成・編集）→ タスク6（削除・詳細）→ タスク7（状態管理）
3. **フェーズ3（品質保証）**: タスク8（ユニットテスト）→ タスク9（統合テスト）→ タスク10（E2Eテスト）→ タスク11（パフォーマンス・エラー）
4. **フェーズ4（統合）**: タスク12（ルーティング・認証統合）

## 要件カバレッジ確認

| 要件ID | 要件概要 | 関連タスク |
|--------|---------|----------|
| 1.1-1.5 | カテゴリ一覧表示 | 1.1, 2.1, 3.1, 4.1, 10.1 |
| 2.1-2.6 | カテゴリ作成 | 1.2, 2.2, 3.2, 5.1, 5.3, 9.1, 10.2 |
| 3.1-3.6 | カテゴリ編集 | 1.2, 2.3, 3.2, 5.2, 5.3, 9.2, 10.2 |
| 4.1-4.6 | カテゴリ削除 | 1.3, 2.3, 3.3, 6.1, 9.2, 10.3 |
| 5.1-5.5 | 有効/無効切り替え | 1.2, 2.4, 3.3, 4.4, 9.3 |
| 6.1-6.5 | 並び替え | 1.4, 2.4, 3.4, 4.3, 9.3, 10.3 |
| 7.1-7.5 | 検索・フィルタリング | 4.2, 10.1 |
| 8.1-8.4 | 使用状況表示 | 1.1, 2.1, 6.2 |
| 9.1-9.5 | バリデーション | 3.2, 5.1, 5.2, 8.2, 10.2 |
| 10.1-10.5 | API エンドポイント | 3.1, 3.2, 3.3, 3.4, 7.2, 9.1, 9.2, 9.3 |
| 非機能要件 | パフォーマンス、セキュリティ | 11.1, 11.2, 12.2 |

✅ **全要件がタスクでカバーされています**